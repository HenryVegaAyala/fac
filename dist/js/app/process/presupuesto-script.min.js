function IniciarForm(){var t=getParameterByName("idproyecto");$("#hdIdProyecto").val(t),ProyectoById(t)}function LimpiarForm(){$("#tableDetalle tbody").html("")}function GoToEdit(){var t=$("#gvDatos .dato.selected"),e="0";precargaExp("#tableDetalle",!0),document.getElementById("txtImporteTotal").value="0.00",document.getElementById("lblImporteTotal").innerText="0.00",t.length>0&&(e=t.attr("data-idpresupuesto"),$.ajax({url:"services/presupuesto/presupuesto-search.php",type:"GET",dataType:"json",data:{tipobusqueda:"2",id:e},success:function(t){var e=0;e=t.length,e>0&&($("#hdIdPrimary").val(t[0].tm_idpresupuesto),$("#lblImporteTotal").text(Number(t[0].tm_presupuestototal).toFixed(2)),$("#ddlMes").val(t[0].tm_per_mes),setProyecto("#pnlInfoProyecto",t[0].tm_idproyecto,t[0].nombreproyecto+" | Proceso: "+arrMeses[parseInt(t[0].tm_per_mes)-1]+" "+t[0].tm_per_ano),ListarAnhoProceso(t[0].tm_per_ano),ListarDetalle())},error:function(t){console.log(t)}})),precargaExp("#tableDetalle",!1),$("#pnlListado").fadeOut(500,function(){$("#pnlRegistro").fadeIn(500,function(){})})}function ListarDetalle(){$.ajax({url:"services/presupuesto/presupuesto-search.php",type:"GET",dataType:"json",data:{tipo:"DETALLE",tipobusqueda:"1",id:$("#hdIdPrimary").val()},success:function(t){var e=0,o=0,a="";if(o=t.length,o>0)for(;e<o;)a+='<tr data-iddetalle="'+t[e].td_idconceptopresupuesto+'" data-idconcepto="'+t[e].tm_idconcepto+'" data-tiporesultado="'+t[e].ta_tiporesultado+'">',a+="<td>"+t[e].tm_idconcepto+" - "+t[e].nombreconcepto+"</td>",a+='<td><input type="text" name="txtCantidad[]" class="cantidad inputTextInTable text-right" value="'+t[e].tm_cantidad+'" /></td>',a+='<td><input type="text" name="txtPrecio[]" class="precio inputTextInTable text-right" value="'+t[e].tm_valor_unitario+'" /></td>',a+='<td class="subtotal">'+t[e].td_valorconcepto+"</td>",a+="</tr>",++e;$("#tableDetalle tbody").html(a),$("#tableDetalle .ibody table").enableCellNavigation(),CalcularTotal()},error:function(t){console.log(t)}})}function CalcularTotal(){var t,e,o=0,a=0,r=0,n=0;if(t=$("#tableDetalle .ibody table"),e=t[0],a=e.rows.length,a>0)for(;o<a;)r=Number(e.rows[o].cells[3].innerText),n+=r,++o;document.getElementById("txtImporteTotal").value=n.toFixed(2),document.getElementById("lblImporteTotal").innerText=n.toFixed(2)}function RegistroPorDefecto(){$.ajax({url:"services/condominio/condominio-search.php",type:"GET",dataType:"json",data:{tipo:"defecto"},success:function(t){var e=0,o="0",a="";e=t.length,e>0&&(o=t[0].idproyecto,a=t[0].nombreproyecto+" | Proceso: "+arrMeses[parseInt(t[0].mesproceso)-1]+" "+t[0].anhoproceso,$("#ddlMes").val(t[0].mesproceso),setProyecto("#pnlInfoProyecto",o,a),setProyecto("#pnlFiltroProyecto",o,a))},error:function(t){console.log(t)}})}function setProyecto(t,e,o){"#pnlInfoProyecto"==t&&$("#hdIdProyecto").val(e),$(t).attr("data-idproyecto",e),$(t+" .info .descripcion").text(o),$("#pnlDatosFiltro").fadeOut("400",function(){if("#pnlInfoProyecto"==t){var e=new Date,o=e.getFullYear();ListarAnhoProceso(o)}else"#pnlFiltroProyecto"==t&&ListarPresupuesto("1")})}function setConcepto(t,e,o){$("#hdIdConcepto").val(t),$("#pnlInfoConcepto").attr("data-idconcepto",t),$("#pnlInfoConcepto").attr("data-nombre",e),$("#pnlInfoConcepto").attr("data-tiporesultado",o),$("#pnlInfoConcepto .info .descripcion").text(e),$("#pnlDatosFiltro").fadeOut("400",function(){})}function ListarProyectos(t){var e="#gvFiltro",o=e+" .gridview";precargaExp(e,!0),$(o).addClass("items-area").addClass("listview").removeClass("card-area"),$.ajax({type:"GET",url:"services/condominio/condominio-search.php",cache:!1,dataType:"json",data:"tipo=asignacion&criterio="+$("#txtSearchFiltro").val()+"&pagina="+t,success:function(e){var a=0,r=0,n="";if(r=e.length,r>0){for(;a<r;)iditem=e[a].idproyecto,n+='<a href="#" class="list dato without-foto bg-gray-glass bg-cyan g200" data-idproyecto="'+iditem+'" data-tipoproyecto="'+e[a].tipoproyecto+'" data-nombre="'+e[a].nombreproyecto+" | Proceso: "+arrMeses[parseInt(e[a].mesproceso)-1]+" "+e[a].anhoproceso+'" data-mes="'+e[a].mesproceso+'" data-anho="'+e[a].anhoproceso+'">',n+='<input name="chkItem[]" type="checkbox" class="oculto" value="'+iditem+'" />',n+='<div class="list-content pos-rel">',n+='<div class="data">',n+='<main><p class="fg-white"><span class="descripcion">'+e[a].nombreproyecto+" | Proceso: "+arrMeses[parseInt(e[a].mesproceso)-1]+" "+e[a].anhoproceso+"</span></p>",n+="</main></div></div>",n+="</a>",++a;paginaFiltro+=1,$("#hdPage").val(paginaFiltro),"1"==t?$(o).html(n):$(o).append(n)}else"1"==t&&$(o).html("<h2>No hay datos.</h2>");precargaExp("#gvFiltro",!1)}})}function ListarConcepto(t){var e="#gvFiltro",o=e+" .gridview";precargaExp(e,!0),$(o).addClass("card-area").removeClass("items-area").removeClass("listview"),$.ajax({url:"services/concepto/concepto-search.php",type:"GET",dataType:"json",cache:!1,data:{tipobusqueda:"4",id:"0",idproyecto:$("#hdIdProyecto").val(),criterio:$("#txtSearchFiltro").val(),tipoconcepto:"01",pagina:t},success:function(a){var r=0,n=0,i="",s="0";if(n=a.length,n>0){for(;r<n;)s=a[r].tm_idconcepto,i+='<div class="card dato bg-cyan pos-rel" data-idconcepto="'+s+'" data-nombre="'+a[r].tm_descripcionconcepto+'" data-formula="'+a[r].tm_definicion_formula+'" data-tiporesultado="'+a[r].ta_tipovalor+'">',i+='<input name="chkItem[]" type="checkbox" class="oculto" value="'+s+'" />',i+='<p class="fg-white"><span class="codigo float-left">'+s+' -&nbsp;</span><span class="descripcion float-left">'+a[r].tm_descripcionconcepto+"</span></p>",i+="</div>",++r;paginaFiltro+=1,$("#hdPage").val(paginaFiltro),"1"==t?$(o).html(i):$(o).append(i)}else"1"==t&&$(o).html("<h2>No hay datos.</h2>");precargaExp(e,!1)},error:function(t){console.log(t)}})}function ListarAnhoProceso(t){$.ajax({url:"services/proceso/proceso-search.php",type:"GET",dataType:"json",data:{tipobusqueda:"ANHO",idproyecto:$("#hdIdProyecto").val()},success:function(e){var o=0,a=0,r="",n="";if(a=e.length,a>0)for(;o<a;)n=t==e[o].per_ano?' selected="selected"':"",r+="<option"+n+' value="'+e[o].per_ano+'">'+e[o].per_ano+"</option>",++o;else r+='<option value="0">NO HAY PROCESOS RELACIONADOS CON EL PROYECTO SELECCIONADO</option>';$("#ddlAnho").html(r)},error:function(t){console.log(t)}})}function DetalleRegistro(t,e,o,a,r,n){this.iditem=t,this.idconcepto=e,this.cantidad=o,this.precio=a,this.subtotal=r,this.tiporesultado=n}function ExtraerDetalle(){var t,e,o=0,a=0,r=[],n="",i="0",s="0",l="0",c="0",p="";if(t=$("#tableDetalle .ibody table"),e=t[0],a=e.rows.length,a>0){for(;o<a;){i=e.rows[o].getAttribute("data-idconcepto"),p=e.rows[o].getAttribute("data-tiporesultado"),s=e.rows[o].cells[1].childNodes[0].value,l=e.rows[o].cells[2].childNodes[0].value,c=e.rows[o].cells[3].innerText;var d=new DetalleRegistro(0,i,s,l,c,p);r.push(d),++o}n=JSON.stringify(r)}return n}function Registrar(){var t,e=new FormData,o="";t=$("#pnlRegistro :input").serializeArray(),o=ExtraerDetalle(),e.append("btnGuardar","btnGuardar"),$.each(t,function(t,o){e.append(o.name,o.value)}),e.append("detalleRegistro",o),$.ajax({url:"services/presupuesto/presupuesto-post.php",type:"POST",cache:!1,dataType:"json",data:e,contentType:!1,processData:!1,success:function(t){MessageBox(t.titulomsje,t.contenidomsje,"[Aceptar]",function(){"0"!=t.rpta&&(BackToPrevPanel(),paginaPresupuesto=1,ListarPresupuesto("1"),$("#btnNuevo, #btnUploadExcel").removeClass("oculto"),$("#btnLimpiarSeleccion, #btnEditar, #btnEliminar, #btnProyeccion").addClass("oculto"))})},error:function(t){console.log(t)}})}function ListarPresupuesto(t){var e="#gvDatos",o=e+" .card-area";precargaExp(e,!0);var a=document.getElementById("pnlFiltroProyecto").getAttribute("data-idproyecto"),r=document.getElementById("txtSearch").value;$.ajax({url:"services/presupuesto/presupuesto-search.php",type:"GET",dataType:"json",data:{tipobusqueda:"1",id:a,criterio:r,pagina:t},success:function(a){var r=0,n=0,i="",s="0";if(n=a.length,n>0){for(;r<n;)s=a[r].tm_idpresupuesto,i+='<div class="card dato bg-cyan heightuno pos-rel" data-idpresupuesto="'+s+'" data-nombre="'+a[r].nombreproyecto+'">',i+='<input name="chkItem[]" type="checkbox" class="oculto" value="'+s+'" />',i+='<p><span class="codigo float-left white-text">'+s+' -&nbsp;</span><span class="descripcion float-left white-text">'+a[r].nombreproyecto+"</span></p>",i+='<div class="expand-data">',i+='<div class="grid fluid pos-rel">',i+='<div class="row">',i+="<label>"+a[r].tm_per_ano+"</label>",i+="</div>",i+='<div class="row">',i+='<h3 class="fg-white padding5">'+arrMeses[parseInt(a[r].tm_per_mes)-1]+"</h3>",i+="</div>",i+='<div class="badge">',i+='<div class="total-card grid fluid">',i+='<div class="row">',i+='<div class="span3 text-total fg-white no-margin">S/.</div>',i+='<div class="span9 subtotal text-total text-right fg-white no-margin">'+Number(a[r].tm_presupuestototal).toFixed(2)+"</div>",i+="</div>",i+="</div>",i+="</div>",i+="</div>",i+="</div>",i+="</div>",++r;paginaPresupuesto+=1,$("#hdPagePresupuesto").val(paginaPresupuesto),"1"==t?$(o).html(i):$(o).append(i)}else"1"==t&&$(o).html("<h2>No hay datos.</h2>");precargaExp(e,!1)},error:function(t){console.log(t)}})}function AgregarPresupuesto(){var t,e="",o=0,a=0;if(t=$("#gvFiltro .dato.selected"),a=t.length,a>0)for(;o<a;)e='<tr data-iddetalle="0" data-idconcepto="'+t[o].getAttribute("data-idconcepto")+'" data-tiporesultado="'+t[o].getAttribute("data-tiporesultado")+'">',e+="<td>"+t[o].getAttribute("data-idconcepto")+" - "+t[o].getAttribute("data-nombre")+"</td>",e+='<td><input type="text" class="cantidad inputTextInTable cantidad text-right" value="0.00" /></td>',e+='<td><input type="text" class="precio inputTextInTable precio text-right" value="0.00" /></td>',e+='<td class="subtotal">0.00</td>',e+="</tr>",$("#tableDetalle tbody").append(e),++o;$("#btnClearFilter").trigger("click"),$("#pnlDatosFiltro").fadeOut(400,function(){}),$("#tableDetalle .ibody table").enableCellNavigation()}function ProyectarPresupuesto(){var t=new FormData,e="0",o=0;precargaExp("#modalProyeccion",!0),e=$("#gvDatos .dato.selected")[0].getAttribute("data-idpresupuesto"),o=document.getElementById("txtNroMeses").value,t.append("btnProyectarPresupuesto","btnProyectarPresupuesto"),t.append("hdIdPresupuesto",e),t.append("txtNroMeses",o),$.ajax({url:"services/presupuesto/presupuesto-post.php",type:"POST",dataType:"json",cache:!1,data:t,contentType:!1,processData:!1,success:function(t){precargaExp("#modalProyeccion",!1),MessageBox(t.titulomsje,t.contenidomsje,"[Aceptar]",function(){"0"!=t.rpta&&(paginaPresupuesto=1,closeCustomModal("#modalProyeccion"),ListarPresupuesto("1"),$("#btnNuevo, #btnUploadExcel").removeClass("oculto"),$("#btnLimpiarSeleccion, #btnEditar, #btnEliminar, #btnProyeccion").addClass("oculto"))})},error:function(t){console.log(t)}})}function EliminarPresupuesto(){indexList=0,elemsSelected=$("#gvDatos .selected").toArray(),EliminarItemPresupuesto(elemsSelected[0])}function EliminarItemPresupuesto(t){var e=new FormData,o="0";o=t.getAttribute("data-idpresupuesto"),e.append("btnEliminar","btnEliminar"),e.append("hdIdPresupuesto",o),$.ajax({url:"services/presupuesto/presupuesto-post.php",type:"POST",dataType:"json",data:e,cache:!1,contentType:!1,processData:!1,success:function(e){var a,r,n=0,i="",s=0;r=$(t),s=r.height(),"0"==e.rpta?(i="El presupuesto "+o+": "+r.find(".descripcion").text(),"ERROR-PROYECTO"==e.contenidomsje&&(i+=" tiene proyectos relacionados."),MessageBox(e.titulomsje,i,"[Aceptar]",function(){})):(++indexList,a=$("#gvDatos .gridview"),n=a.scrollTop(),r.fadeOut(400,function(){$(this).remove()}),indexList<=elemsSelected.length-1?(n+=s+18,a.animate({scrollTop:n},400,function(){EliminarItemPresupuesto(elemsSelected[indexList])})):MessageBox(e.titulomsje,e.contenidomsje,"[Aceptar]",function(){$("#btnLimpiarSeleccion").trigger("click")}))},error:function(t){console.log(t)}})}$(function(){$("#txtSearch").keydown(function(t){if(t.keyCode==$.ui.keyCode.ENTER)return $("#btnSearch").trigger("click"),!1}).keypress(function(t){if(t.keyCode==$.ui.keyCode.ENTER)return!1}),$("#btnSearch").on("click",function(t){t.preventDefault(),$("#btnLimpiarSeleccion").trigger("click"),paginaPresupuesto=1,ListarPresupuesto("1")}),$("#gvDatos").on("click",".dato",function(t){t.preventDefault();var e=$(this).find("input:checkbox");$(this).hasClass("selected")?($(this).removeClass("selected"),e.removeAttr("checked"),0==$("#gvDatos .dato.selected").length?($("#btnNuevo, #btnUploadExcel").removeClass("oculto"),$("#btnLimpiarSeleccion, #btnProyeccion, #btnEditar, #btnEliminar").addClass("oculto")):1==$("#gvDatos .dato.selected").length&&$("#btnLimpiarSeleccion, #btnProyeccion, #btnEditar").removeClass("oculto")):($(this).addClass("selected"),e.attr("checked",""),$("#btnNuevo, #btnUploadExcel").addClass("oculto"),$("#btnLimpiarSeleccion, #btnEliminar").removeClass("oculto"),1==$("#gvDatos .dato.selected").length?$("#btnEditar, #btnProyeccion").removeClass("oculto"):$("#btnEditar, #btnProyeccion").addClass("oculto"))}),$("#btnLimpiarSeleccion").on("click",function(t){t.preventDefault(),$("#hdIdPrimary").val("0"),$("#gvDatos .dato.selected").removeClass("selected"),$("#gvDatos input:checkbox:checked").removeAttr("checked"),$("#btnNuevo, #btnUploadExcel, #btnSelectAll").removeClass("oculto"),$("#btnLimpiarSeleccion, #btnProyeccion, #btnEditar, #btnEliminar").addClass("oculto")}),$("#btnSelectAll").on("click",function(t){t.preventDefault(),$(this).addClass("oculto"),$("#gvDatos .dato").addClass("selected"),$("#gvDatos input:checkbox").attr("checked",""),$("#btnNuevo, #btnProyeccion, #btnUploadExcel, #btnEditar").addClass("oculto"),$("#btnLimpiarSeleccion, #btnEliminar").removeClass("oculto")}),$("#btnProyeccion").on("click",function(t){t.preventDefault(),openCustomModal("#modalProyeccion")}),$("#btnProyectarPresupuesto").on("click",function(t){t.preventDefault(),ProyectarPresupuesto()}),$("#gvDatos > .gridview").on("scroll",function(){var t=0;$(this).scrollTop()+$(this).innerHeight()>=$(this)[0].scrollHeight&&(t=Number($("#hdPagePresupuesto").val()),ListarPresupuesto(t))}),$("#btnBackPrevPanel").on("click",function(t){t.preventDefault(),BackToPrevPanel()}),$("#btnAddDetalle").on("click",function(t){t.preventDefault()}),$("#pnlInfoProyecto").add("#pnlFiltroProyecto").add("#btnAddDetalle").on("click",function(t){t.preventDefault();var e,o="",a="";e=this,o=e.getAttribute("data-tipofiltro"),a=e.getAttribute("data-hint"),paginaFiltro=1,"proyecto"==o||"filtroproyecto"==o?($("#pnlDatosFiltro").removeClass("with-appbar"),$("#pnlDatosFiltro .appbar").addClass("oculto"),ListarProyectos("1")):"concepto"==o&&($("#pnlDatosFiltro").addClass("with-appbar"),$("#pnlDatosFiltro .appbar").removeClass("oculto"),ListarConcepto("1")),$("#pnlDatosFiltro").attr("data-tipofiltro",o),$("#txtTituloFiltro").text(a),$("#pnlDatosFiltro").fadeIn(400,function(){})}),$("#btnHideFiltro").on("click",function(t){t.preventDefault(),$("#pnlDatosFiltro").fadeOut(400,function(){})}),$("#gvFiltro > .gridview").on("scroll",function(){var t=0,e="";$(this).scrollTop()+$(this).innerHeight()>=$(this)[0].scrollHeight&&(t=Number($("#hdPage").val()),e=$("#pnlDatosFiltro").attr("data-tipofiltro"),"proyecto"==e?ListarProyectos(t):"concepto"==e&&ListarConcepto(t))}),$("#btnClearFilter").on("click",function(t){t.preventDefault(),$("#btnClearFilter, #btnAsignFilter").addClass("oculto"),$("#btnSelectAllFilter").removeClass("oculto"),$("#gvFiltro input:checkbox").removeAttr("checked"),$("#gvFiltro .dato").removeClass("selected")}),$("#btnSelectAllFilter").on("click",function(t){t.preventDefault(),$(this).addClass("oculto"),$("#btnClearFilter, #btnAsignFilter").removeClass("oculto"),$("#gvFiltro input:checkbox").attr("checked",""),$("#gvFiltro .dato").addClass("selected")}),$("#btnAsignFilter").on("click",function(t){t.preventDefault(),AgregarPresupuesto()}),$("#txtSearchFiltro").keydown(function(t){if(t.keyCode==$.ui.keyCode.ENTER)return $("#btnSearchFiltro").trigger("click"),!1}).keypress(function(t){if(t.keyCode==$.ui.keyCode.ENTER)return!1}),$("#btnSearchFiltro").on("click",function(t){t.preventDefault();var e="";paginaFiltro=1,e=$("#pnlDatosFiltro").attr("data-tipofiltro"),$("#btnClearFilter").trigger("click"),"proyecto"==e||"filtroproyecto"==e?ListarProyectos("1"):"concepto"==e&&ListarConcepto("1")}),$("#gvFiltro").on("click",".dato",function(t){t.preventDefault();var e,o,a="0",r="",n="",i="";e=document.getElementById("pnlDatosFiltro"),n=e.getAttribute("data-tipofiltro"),"concepto"==n?(o=$(this).find("input:checkbox"),$(this).hasClass("selected")?($(this).removeClass("selected"),o.removeAttr("checked"),0==$("#gvFiltro .dato.selected").length&&$("#btnClearFilter, #btnAsignFilter").addClass("oculto")):($(this).addClass("selected"),o.attr("checked",""),$("#btnClearFilter, #btnAsignFilter").removeClass("oculto"))):(a=this.getAttribute("data-idproyecto"),r=this.getAttribute("data-nombre"),i="proyecto"==n?"#pnlInfoProyecto":"#pnlFiltroProyecto",$("#ddlMes").val(this.getAttribute("data-mes")),setProyecto(i,a,r))}),$("#tableDetalle tbody").on({click:function(t){return t.preventDefault(),$(this).select(),!1},keyup:function(t){var e=0,o=0,a=0;$(this).hasClass("cantidad")?(e=Number($(this).val()),o=Number($(this).parent().parent().find(".precio").val())):$(this).hasClass("precio")&&(e=Number($(this).parent().parent().find(".cantidad").val()),o=Number($(this).val())),a=e*o,$(this).parent().parent().find(".subtotal").text(a.toFixed(2)),CalcularTotal()}},"input:text"),$("#btnAgregar").on("click",function(t){t.preventDefault(),AgregarPresupuesto()}),$("#btnGuardar").on("click",function(t){t.preventDefault(),Registrar()}),$("#btnNuevo, #btnEditar").on("click",function(t){t.preventDefault(),LimpiarForm(),GoToEdit()}),$("#btnEliminar").on("click",function(t){t.preventDefault();var e=confirm("¿Desea eliminar los elementos seleccionados?");e&&EliminarPresupuesto()}),$("#btnCancelar").on("click",function(t){t.preventDefault(),$("#pnlRegistro").fadeOut(400,function(){$("#pnlListado").fadeIn(400)})})});var indexList=0,elemsSelected,paginaFiltro=1,paginaPresupuesto=1,arrMeses=["Enero","Febrero","Marzo","Abril","Mayo","Junio","Julio","Agosto","Septiembre","Octubre","Noviembre","Diciembre"];