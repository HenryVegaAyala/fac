function IniciarForm(){var e=window.top.idproyecto,a=window.top.anho,t=window.top.mes,o=window.top.escobrodiferenciado;window.top.estadoproceso;$("#hdIdProyecto").val(e),$("#hdIdConsumoProyecto").val(e),$("#hdAnho").val(a),$("#hdMes").val(t),"0"==o?($("#btnAscensor").addClass("oculto"),$("#tabCalculoAscensor").is(":visible")&&$("#groupOpcionesFactura .btn:first").trigger("click")):$("#btnAscensor").removeClass("oculto"),$("#tabFacturacion").is(":visible")?(paginaGenFacturacion=1,ListarFacturacion("#gvGenFacturacion","1")):$("#groupVistaConsumo .btn.btn-success").trigger("click")}function ListarConcepto(e){var a="#gvFiltro",t=a+" .gridview";precargaExp(a,!0),$(t).addClass("items-area").addClass("listview").removeClass("card-area"),$.ajax({url:"services/concepto/concepto-search.php",type:"GET",dataType:"json",data:{tipobusqueda:"4",id:"0",idproyecto:$("#hdIdProyecto").val(),criterio:$("#txtSearchFiltro").val(),tipoconcepto:"02",pagina:e},success:function(o){var n=0,r=0,c="";if(r=o.length,r>0){for(;n<r;)iditem=o[n].tm_idconcepto,c+='<a href="#" class="list dato without-foto bg-gray-glass bg-cyan g200" data-idconcepto="'+iditem+'" data-tipoconcepto="'+o[n].ta_tipoconcepto+'" data-descripcion="'+o[n].tm_descripcionconcepto+'">',c+='<input name="chkItem[]" type="checkbox" class="oculto" value="'+iditem+'" />',c+='<div class="list-content pos-rel">',c+='<div class="data">',c+='<main><p class="fg-white"><span class="descripcion">'+o[n].tm_descripcionconcepto+"</span></p>",c+="</main></div></div>",c+="</a>",++n;paginaConcepto+=1,$("#hdPageConcepto").val(paginaConcepto),"1"==e?$(t).html(c):$(t).append(c)}else"1"==e&&$(t).html("<h2>No hay datos.</h2>");precargaExp(a,!1)},error:function(e){console.log(e)}})}function ShowPanelCalculoAguaMeses(){$("#pnlCalculoAguaMeses").fadeIn(400,function(){})}function CalcularAguaMeses(){var e=new FormData;precargaExp("#tableConsumoAgua",!0),e.append("tipo","CONSUMOAGUAMES"),e.append("idproyecto",$("#hdIdConsumoProyecto").val()),e.append("mesini",$("#ddlMesInicio").val()),e.append("mesfin",$("#ddlMesFin").val()),$.ajax({type:"GET",url:"services/facturacion/facturacion-search.php",dataType:"json",data:{tipo:"CONSUMOAGUAMES",idproyecto:$("#hdIdConsumoProyecto").val(),mesini:$("#ddlMesInicio").val(),mesfin:$("#ddlMesFin").val()},cache:!1,success:function(e){var a=0,t=0,o="";if(precargaExp("#tableConsumoAgua",!1),t=e.length,t>0){for(;a<t;)o+='<tr data-idpropiedad="'+e[a].idpropiedad+'">',o+="<td>"+e[a].descripcionpropiedad+"</td>",o+='<td class="consumo">'+Number(e[a].consumopromedio).toFixed(2)+"</td>",o+="</tr>",++a;$("#btnCalcularConsumo").removeClass("oculto")}else $("#btnCalcularConsumo").addClass("oculto");$("#tableConsumoAgua tbody").html(o)},error:function(e){console.log(e)}})}function setPropietario(e,a){var t;t=$('#tablePropietario tbody tr[data-edit="true"]'),t.attr({"data-edit":"false","data-idpropietario":e}).find("h3").text(a),closePanelPropietario()}function closePanelPropietario(){$("#pnlSearchPropietario").fadeOut(400)}function RegistroPorDefectoId(e){$.ajax({url:"services/condominio/condominio-search.php",type:"GET",dataType:"json",data:{tipo:"defecto",tipobusqueda:e},success:function(e){var a=0,t="0",o="",n="";a=e.length,a>0&&(t=e[0].idproyecto,o=e[0].nombreproyecto+" | Proceso: "+arrMeses[parseInt(e[0].mesproceso)-1]+" "+e[0].anhoproceso,n=e[0].escobrodiferenciado,$("#ddlMes").val(e[0].mesproceso),setProyecto(t,o,n))},error:function(e){console.log(e)}})}function RegistroPorDefecto(){$.ajax({url:"services/condominio/condominio-search.php",type:"GET",dataType:"json",data:{tipo:"defecto"},success:function(e){var a=0,t="0",o="",n="";a=e.length,a>0&&(t=e[0].idproyecto,o=e[0].nombreproyecto+" | Proceso: "+arrMeses[parseInt(e[0].mesproceso)-1]+" "+e[0].anhoproceso,n=e[0].escobrodiferenciado,$("#ddlMes").val(e[0].mesproceso),setProyecto(t,o,n))},error:function(e){console.log(e)}})}function setProyecto(e,a,t){$("#hdIdProyecto").val(e),$("#hdIdConsumoProyecto").val(e),$("#pnlInfoProyecto").attr("data-idproyecto",e),$("#pnlInfoProyecto .info .descripcion").text(a),$("#pnlConsumoProyecto").attr("data-idproyecto",e),$("#pnlConsumoProyecto .info .descripcion").text(a),"0"==t?($("#btnAscensor").addClass("oculto"),$("#tabCalculoAscensor").is(":visible")&&$("#pnlListado > .title-window button:first").trigger("click")):$("#btnAscensor").removeClass("oculto"),$("#pnlDatosFiltro").fadeOut("400",function(){var e=new Date,a=e.getFullYear();ListarAnhoProceso(a)})}function setConsumoProyecto(e,a,t){$("#hdIdConsumoProyecto").val(e),$("#pnlConsumoProyecto").attr("data-idproyecto",e),$("#pnlConsumoProyecto .info .descripcion").text(a),$("#pnlDatosFiltro").fadeOut("400",function(){})}function setConcepto(e,a,t){$("#hdIdConcepto").val(e),$("#hdConceptoEscalonable").val(t),$("#pnlInfoConcepto").attr("data-idconcepto",e),$("#pnlInfoConcepto .info .descripcion").text(a),$("#pnlDatosFiltro").fadeOut("400",function(){})}function ListarProyectos(e){var a="#gvFiltro",t=a+" .gridview";precargaExp(a,!0),$(t).addClass("items-area").addClass("listview").removeClass("card-area"),$.ajax({type:"GET",url:"services/condominio/condominio-search.php",cache:!1,dataType:"json",data:"tipo=asignacion&criterio="+$("#txtSearchFiltro").val()+"&pagina="+e,success:function(a){var o=0,n=0,r="";if(n=a.length,n>0){for(;o<n;)iditem=a[o].idproyecto,r+='<a href="#" class="list dato without-foto bg-gray-glass bg-cyan g200" data-idproyecto="'+iditem+'" data-tipoproyecto="'+a[o].tipoproyecto+'" data-nombre="'+a[o].nombreproyecto+'" data-escobrodiferenciado="'+a[o].escobrodiferenciado+'" data-mes="'+a[o].mesproceso+'" data-anho="'+a[o].anhoproceso+'">',r+='<input name="chkItem[]" type="checkbox" class="oculto" value="'+iditem+'" />',r+='<div class="list-content pos-rel">',r+='<div class="data">',r+='<main><p class="fg-white"><span class="descripcion">'+a[o].nombreproyecto+" | Proceso: "+arrMeses[parseInt(a[o].mesproceso)-1]+" "+a[o].anhoproceso+"</span></p>",r+="</main></div></div>",r+="</a>",++o;paginaFiltro+=1,$("#hdPageProyecto").val(paginaFiltro),"1"==e?$(t).html(r):$(t).append(r)}else"1"==e&&$(t).html("<h2>No hay datos.</h2>");precargaExp("#gvFiltro",!1)}})}function ListarAnhoProceso(e){$.ajax({url:"services/proceso/proceso-search.php",type:"GET",dataType:"json",data:{tipobusqueda:"ANHO",idproyecto:$("#hdIdProyecto").val()},success:function(a){var t=0,o=0,n="",r="";if(o=a.length,o>0)for(;t<o;)r=e==a[t].per_ano?' selected="selected"':"",n+="<option"+r+' value="'+a[t].per_ano+'">'+a[t].per_ano+"</option>",++t;else n+='<option value="0">NO HAY PROCESOS RELACIONADOS CON EL PROYECTO SELECCIONADO</option>';$("#ddlAnho").html(n),$("#ddlAnhoImport").html(n),$("#tabFacturacion").is(":visible")?(paginaGenFacturacion=1,ListarFacturacion("#gvGenFacturacion","1")):$(".span-button.success").trigger("click")},error:function(e){console.log(e)}})}function ListarPropiedades(e){var a="#gvPropiedad";precargaExp(a,!0);var t=a+" .gridview";$.ajax({type:"GET",url:"services/propiedad/propiedad-search.php",cache:!1,dataType:"json",data:{tipobusqueda:"1",id:$("#hdIdProyecto").val(),idtipopropiedad:$("#ddlTipoPropiedadFiltro").val(),criterio:$("#txtSearchPropiedad").val(),pagina:e},success:function(o){var n=0,r="",c="",i=o.length;if(i>0){for(;n<i;){var s=o[n].idpropiedad,d=o[n].idtipopropiedad,l="";l=null!=o[n].descrippersona?0==o[n].descrippersona.trim().length?"(EN BLANCO)":o[n].descrippersona:"(EN BLANCO)","DPT"==d?c=" blue-grey lighten-2":"DEP"==d?c=" grey darken-1":"EST"==d?c=" blue-grey":"TIE"==d&&(c=" blue-grey darken-1"),r+='<div class="tile dato double bg-gray-glass '+c+'" ',r+='data-idpropiedad="'+s+'" ',r+='data-idtipopropiedad="'+d+'" ',r+='data-descripcion="'+o[n].descripcionpropiedad+'" ',r+='data-area="'+o[n].area+'">',r+='<input name="chkItem[]" type="checkbox" class="oculto" value="'+s+'" />',r+='<div class="tile_true_content">',r+='<div class="tile-content">',r+='<div class="text-right padding10 ntp">',r+='<h2 class="white-text">'+o[n].descripcionpropiedad+"</h2>",r+='<h6 class="padding5 text-ellipsis smaller bg-white text-center fg-dark">'+l+"</h6>",r+="</div></div>",r+='<div class="brand"><span class="badge bg-dark">Area: '+o[n].area+" (m<sup>2</sup>)</span></div>",r+="</div>",r+="</div>",++n}paginaPropiedad+=1,$("#hdPagePropiedad").val(paginaPropiedad),1==e?$(t).html(r):$(t).append(r),$(t).find(".dato").eq(0).trigger("click")}else 1==e&&$(t).html("<h2>No se encontraron resultados.</h2>");precargaExp(a,!1)}})}function addValidFormRegister(){$("#txtFechaVencimiento").rules("add",{required:!0,date:!0}),$("#txtFechaTope").rules("add",{required:!0,date:!0})}function removeValidFormRegister(){$("#txtFechaVencimiento").rules("remove"),$("#txtFechaTope").rules("remove")}function GenerarFacturacion(){indexList=0,progress=0,nroFacturas=0,elemsSelected=[],completado=!1,progressError=!1,$("#form1").valid()&&(precargaExp("#pnlListado > .gp-body",!0),$("#btnFinalizarEnvio_Facturacion").addClass("oculto"),$("#btnCancelarEnvio_Facturacion").removeClass("oculto"),openModalCallBack("#modalGenFacturacion",function(){$.ajax({url:"services/propiedad/propiedad-search.php",type:"GET",dataType:"json",data:{tipo:"allfields",tipobusqueda:"4",idtipopropiedad:"*",id:$("#hdIdProyecto").val(),criterio:"",pagina:"0"},success:function(e){precargaExp("#pnlListado > .gp-body",!1);var a=0;precargaExp("#modalGenFacturacion",!1),elemsSelected=e,a=e.length,nroFacturas=a,$("#lblNroPropEncontradas").text(a),GenerarFacturacion_Individual(e[0])},error:function(e){console.log(e)}})}))}function EliminarFacturacionPrevia(){var e=new FormData;e.append("btnEliminarFacturacionPrevia","btnEliminarFacturacionPrevia"),e.append("hdIdProyecto",$("#hdIdProyecto").val()),e.append("hdAnho",$("#hdAnho").val()),e.append("hdMes",$("#hdMes").val()),$.ajax({url:"services/facturacion/facturacion-post.php",type:"POST",dataType:"json",data:e,cache:!1,contentType:!1,processData:!1,success:function(e){"0"==e.rpta?MessageBox(e.titulomsje,e.contenidomsje,"[Aceptar]",function(){}):GenerarFacturacion()},error:function(e){console.log(e)}})}function GenerarFacturacion_Individual(e){var a=e.idpropiedad,t=new FormData;t.append("btnRegenerar","btnRegenerar"),t.append("hdTipoFacturacion","1"),t.append("hdIdPropiedad",a),t.append("hdIdProyecto",$("#hdIdProyecto").val()),t.append("hdAnho",$("#hdAnho").val()),t.append("hdMes",$("#hdMes").val()),t.append("txtFechaVencimiento",$("#txtFechaVencimiento").val()),t.append("txtFechaTope",$("#txtFechaTope").val()),$.ajax({url:"services/facturacion/facturacion-post.php",type:"POST",dataType:"json",data:t,cache:!1,contentType:!1,processData:!1,success:function(a){var t=0;++indexList,progressError=!1,t=Math.round(100*indexList/nroFacturas),$("#lblNroFactCalculadas").text(indexList),$("#lblPorcentajeEnvio_Facturacion").text(t),$("#lblDescripFactura_Facturacion").text(e.idpropiedad+" - "+e.descripcionpropiedad),indexList<=elemsSelected.length-1?GenerarFacturacion_Individual(elemsSelected[indexList]):(completado=!0,$("#btnFinalizarEnvio_Facturacion").removeClass("oculto"),$("#btnCancelarEnvio_Facturacion").addClass("oculto"),MessageBox(a.titulomsje,a.contenidomsje,"[Aceptar]",function(){closeCustomModal("#modalGenFacturacion"),"0"!=a.rpta&&(paginaGenFacturacion=1,ListarFacturacion("#gvGenFacturacion","1"))}))},beforeSend:function(){},complete:function(){progress=0,progressError&&0==completado&&setTimeout(function(){GenerarFacturacion_Individual(elemsSelected[indexList])},1e4)},error:function(e){progress=0,progressError=!0,console.log(e)}})}function RegenerarFacturacion(){var e=new FormData;precargaExp("#pnlListado > .gp-body",!0);var a=$("#gvGenFacturacion .dato.selected")[0],t=a.getAttribute("data-idpropiedad");e.append("btnRegenerar","btnRegenerar"),e.append("hdTipoFacturacion","2"),e.append("hdIdPropiedad",t),e.append("hdIdProyecto",$("#hdIdProyecto").val()),e.append("hdAnho",$("#hdAnho").val()),e.append("hdMes",$("#hdMes").val()),e.append("txtFechaVencimiento",$("#txtFechaVencimiento").val()),e.append("txtFechaTope",$("#txtFechaTope").val()),$.ajax({url:"services/facturacion/facturacion-post.php",type:"POST",dataType:"json",data:e,cache:!1,contentType:!1,processData:!1,success:function(e){precargaExp("#pnlListado > .gp-body",!1),MessageBox(e.titulomsje,e.contenidomsje,"[Aceptar]",function(){"0"!=e.rpta&&(paginaGenFacturacion=1,ListarFacturacion("#gvGenFacturacion","1"))})},error:function(e){console.log(e)}})}function ListarFacturacion(e,a){var t=e+" .gridview";precargaExp(e,!0),$.ajax({url:"services/facturacion/facturacion-search.php",type:"GET",dataType:"json",data:{tipobusqueda:"3",criterio:$("#txtSearchFacturacion").val(),id:$("#hdIdProyecto").val(),anho:$("#hdAnho").val(),mes:$("#hdMes").val(),idtipopropiedad:$("#ddlTipoPropiedadFacturacion").val(),pagina:a},success:function(o){var n=0,r=0,c="",i="0",s=0;if(r=o.length,r>0){for(;n<r;)i=o[n].tm_idfacturacion,c+='<div class="card dato bg-cyan heightuno half-col pos-rel" data-idfacturacion="'+i+'" data-nombre="'+o[n].nombreproyecto+'" data-idpropiedad="'+o[n].idpropiedad+'" data-codigo="'+o[n].tm_codigo+'">',c+='<input name="chkItem[]" type="checkbox" class="oculto" value="'+i+'" />',c+='<p><span class="descripcion float-left white-text">'+o[n].nombreproyecto+"</span></p>",c+='<div class="expand-data">',c+='<div class="grid fluid pos-rel">',c+='<div class="row">',c+="<label>"+o[n].tm_per_ano+"</label>",c+="</div>",c+='<div class="row">',c+='<h3 class="fg-white padding5">'+arrMeses[parseInt(o[n].tm_per_mes)-1]+"</h3>",c+="</div>",c+='<div class="badge">',c+='<div class="total-card grid fluid">',c+='<div class="row">',c+='<div class="span3 text-total fg-white no-margin">S/.</div>',c+='<div class="span9 subtotal text-total text-right fg-white no-margin">'+RedondeoMagico(o[n].tm_importefacturado).toFixed(2)+"</div>",c+="</div>",c+="</div>",c+="</div>",c+="</div>",c+="</div>",c+="</div>",++n;"1"==a?(s=0,$(t).html(c)):("#gvGenFacturacion"==e&&(s=$("#gvGenFacturacion .dato").length),$(t).append(c)),"#gvGenFacturacion"==e?($(t).find(".dato").eq(s).trigger("click"),paginaGenFacturacion+=1,$("#hdPageGenFacturacion").val(paginaGenFacturacion),$card=$("#gvGenFacturacion .dato"),$("#btnExportarTotalesFacturaExcel, #btnExportarFacturasExcel, #btnRegenerar, #btnEliminar, #btnVistaPrevia, #btnGuardarConcepto, #btnDivisionFactura, #btnEnviarEmail, #btnImprimirFactura").removeClass("oculto")):"#gvFacturacion"==e&&(paginaFacturacion+=1,$("#hdPageFacturacion").val(paginaFacturacion))}else"1"==a&&($("#lblTotalConceptoFact").text("0.00"),$(t).html("<h2>No hay datos.</h2>"),$("#btnRegenerar, #btnEliminar, #btnVistaPrevia, #btnGuardarConcepto, #btnDivisionFactura, #btnEnviarEmail, #btnImprimirFactura").addClass("oculto"),$("#tableConcepto tbody").html(""));precargaExp(e,!1)},error:function(e){console.log(e)}})}function CalcularTotal(){var e,a,t=0,o=0,n="0",r="0",c=0,i=0;if(e=$("#tableConcepto .ibody table"),a=e[0],o=a.rows.length,o>0)for(;t<o;)n=a.rows[t].getAttribute("data-esformula"),r=a.rows[t].getAttribute("data-escalonable"),c="0"==n&&"0"==r?Number(a.rows[t].cells[1].childNodes[0].value):Number(a.rows[t].cells[1].innerText),i+=c,++t;var s=i.toFixed(2),d=s.toString(),l=RedondeoMagico(d);document.getElementById("lblTotalConceptoFact").innerText=Number(l).toFixed(2)}function ListarDetalle(e){precargaExp("#tableConcepto",!0),$.ajax({url:"services/facturacion/facturacion-search.php",type:"GET",dataType:"json",data:{tipo:"DETALLE",tipobusqueda:"1",id:e},success:function(e){var a=0,t=0,o="",n="",r="0",c="0",i="0";if(precargaExp("#tableConcepto",!1),t=e.length,t>0){for(;a<t;)r=e[a].esformula,c=e[a].escalonable,i=e[a].td_valorconcepto,n="0"==r&&"0"==c?'<input type="text" class="inputTextInTable text-center" value="'+i+'" />':i,o+='<tr data-iddetalle="'+e[a].td_idconceptofacturacion+'" data-idconcepto="'+e[a].tm_idconcepto+'" data-tiporesultado="'+e[a].ta_tiporesultado+'" data-esformula="'+r+'" data-escalonable="'+c+'">',o+="<td>"+e[a].tm_idconcepto+" - "+e[a].nombreconcepto+"</td>",o+='<td class="subtotal text-center">'+n+"</td>",o+="</tr>",++a;$("#tableConcepto tbody").html(o),$("#tableConcepto .ibody table").enableCellNavigation(),$("#btnGuardarConcepto").removeClass("oculto")}else $("#tableConcepto tbody").html(""),$("#btnGuardarConcepto").addClass("oculto");CalcularTotal()},error:function(e){console.log(e)}})}function ListarPropiedadConsumo(e){precargaExp("#tablePropiedad",!0);var a="consulta"==e?"2":"1";$.ajax({url:"services/facturacion/facturacion-search.php",type:"GET",dataType:"json",data:{tipo:"PROPCONSUMO",tipobusqueda:a,idproyecto:$("#hdIdProyecto").val(),anho:$("#hdAnho").val(),mes:$("#hdMes").val()},success:function(e){var a=0,t=e.length,o="",n=0;if(precargaExp("#tablePropiedad",!1),t>0){for(;a<t;){var r=Number(e[a].td_consumoperiodo).toFixed(3),c=Number(e[a].consumoimporte).toFixed(2),i=r<0?' class="red white-text"':"";o+="<tr"+i+' data-iddetalle="'+e[a].td_idconsumoescalonable+'" data-idpropiedad="'+e[a].tm_idpropiedad+'">',o+="<td>",o+=e[a].tm_descripcionpropiedad+"</td>",o+='<td><input type="text" name="txtLecturaAnterior[]" class="lecanterior inputTextInTable text-right" value="'+Number(e[a].td_lecturaanterior).toFixed(3)+'" /></td>',o+='<td><input type="text" name="txtLecturaActual[]" class="lecactual inputTextInTable text-right" value="'+Number(e[a].td_lecturaactual).toFixed(3)+'" /></td>',o+='<td class="consumo">'+r+"</td>",o+='<td class="consumoimporte">'+c+"</td>",o+='<td><input type="text" name="txtFechaInicio[]" class="fechaini inputTextInTable text-right" value="'+convertDate(e[a].fechaini)+'" /></td>',o+='<td><input type="text" name="txtFechaFin[]" class="fechafin inputTextInTable text-right" value="'+convertDate(e[a].fechafin)+'" /></td>',o+="</tr>",n+=Number(e[a].td_consumoperiodo),++a}$("#btnCalcularConsumo, #btnIngresoFechasConsumo").removeClass("oculto")}else $("#btnCalcularConsumo, #btnIngresoFechasConsumo").addClass("oculto");$("#tablePropiedad tbody").html(o),$("#tablePropiedad .ibody table").enableCellNavigation(),$("#lblTotalConsumo").text(n.toFixed(3))},error:function(e){console.log(e)}})}function ListarPropiedadConsumo_Concepto(e){precargaExp("#tablePropiedadConcepto",!0);var a="consulta"==e?"2":"1";$.ajax({url:"services/facturacion/facturacion-search.php",type:"GET",dataType:"json",data:{tipo:"PROPCONSUMO_CONCEPTO",tipobusqueda:a,idproyecto:$("#hdIdProyecto").val(),idconcepto:$("#hdIdConcepto").val(),anho:$("#hdAnho").val(),mes:$("#hdMes").val()},success:function(e){var a=0,t=e.length,o="",n=0;if(precargaExp("#tablePropiedadConcepto",!1),t>0){for(;a<t;){var r=Number(e[a].td_importe)<0?' class="red white-text"':"";o+="<tr"+r+' data-iddetalle="'+e[a].td_idconsumoconcepto+'" data-idpropiedad="'+e[a].tm_idpropiedad+'">',o+="<td>",o+=e[a].tm_descripcionpropiedad+"</td>",o+='<td><input type="text" name="conceptovariable['+a+'][importe]" class="importeconcepto inputTextInTable text-right" value="'+Number(e[a].td_importe).toFixed(2)+'" /></td>',o+="</tr>",n+=Number(e[a].td_importe),++a}$("#btnCalcularConsumo_Concepto").removeClass("oculto")}else $("#btnCalcularConsumo_Concepto").addClass("oculto");$("#tablePropiedadConcepto tbody").html(o),$("#tablePropiedadConcepto .ibody table").enableCellNavigation(),$("#lblTotalConceptoVariable").text(n.toFixed(0))},error:function(e){console.log(e)}})}function DetalleConcepto(e,a){this.iditem=e,this.valorconcepto=a}function ExtraerDetalleConcepto(){var e,a,t=0,o=0,n=[],r="",c="0",i="0",s="0",d="0";if(e=$("#tableConcepto .ibody table"),a=e[0],o=a.rows.length,o>0){for(;t<o;){if(i=a.rows[t].getAttribute("data-esformula"),s=a.rows[t].getAttribute("data-escalonable"),"0"==i&&"0"==s){c=a.rows[t].getAttribute("data-iddetalle"),d=a.rows[t].cells[1].childNodes[0].value;var l=new DetalleConcepto(c,d);n.push(l)}++t}r=JSON.stringify(n)}return r}function DetalleConsumo(e,a,t,o,n,r,c){this.iditem=e,this.idpropiedad=a,this.lecturaanterior=t,this.lecturaactual=o,this.consumo=n,this.fechaini=r,this.fechafin=c}function DetalleConsumo_Concepto(e,a,t){this.iditem=e,this.idpropiedad=a,this.importe=t}function RegistrarCalculoConsumo(){var e=new FormData;precargaExp("#pnlListado > .gp-body",!0);var a=0,t=$("#tablePropiedad .ibody table"),o=t[0],n=o.rows.length,r=[],c="";if(n>0){for(;a<n;){var i=o.rows[a].getAttribute("data-iddetalle"),s=o.rows[a].getAttribute("data-idpropiedad"),d=o.rows[a].cells[1].childNodes[0].value,l=o.rows[a].cells[2].childNodes[0].value,p=o.rows[a].cells[3].innerText,u=o.rows[a].cells[5].childNodes[0].value,h=o.rows[a].cells[6].childNodes[0].value,m=new DetalleConsumo(i,s,d,l,p,u,h);r.push(m),++a}c=JSON.stringify(r)}e.append("btnCalcularConsumo","btnCalcularConsumo"),e.append("hdIdProyecto",$("#hdIdProyecto").val()),e.append("hdAnho",$("#hdAnho").val()),e.append("hdMes",$("#hdMes").val()),e.append("detallePropiedad",c),$.ajax({url:"services/facturacion/facturacion-post.php",type:"POST",dataType:"json",data:e,cache:!1,contentType:!1,processData:!1,success:function(e){precargaExp("#pnlListado > .gp-body",!1),MessageBox(e.titulomsje,e.contenidomsje,"[Aceptar]",function(){"0"!=e.rpta&&(ListarPropiedadConsumo("consulta"),ListarSumaConceptoAgua())})},error:function(e){console.log(e)}})}function RegistrarCalculoConsumo_Concepto(){var e=new FormData;precargaExp("#pnlListado > .gp-body",!0);var a=0,t=$("#tablePropiedadConcepto .ibody table"),o=t[0],n=o.rows.length,r=[],c="";if(n>0){for(;a<n;){var i=o.rows[a].getAttribute("data-iddetalle"),s=o.rows[a].getAttribute("data-idpropiedad"),d=o.rows[a].cells[1].childNodes[0].value,l=new DetalleConsumo_Concepto(i,s,d);r.push(l),++a}c=JSON.stringify(r)}e.append("btnCalcularConsumo_Concepto","btnCalcularConsumo_Concepto"),e.append("hdIdProyecto",$("#hdIdProyecto").val()),e.append("hdIdConcepto",$("#hdIdConcepto").val()),e.append("hdAnho",$("#hdAnho").val()),e.append("hdMes",$("#hdMes").val()),e.append("detallePropiedad",c),$.ajax({url:"services/facturacion/facturacion-post.php",type:"POST",dataType:"json",data:e,cache:!1,contentType:!1,processData:!1,success:function(e){precargaExp("#pnlListado > .gp-body",!1),MessageBox(e.titulomsje,e.contenidomsje,"[Aceptar]",function(){"0"!=e.rpta&&ListarPropiedadConsumo_Concepto("consulta")})},error:function(e){console.log(e)}})}function GuardarConceptoFact(){var e,a=new FormData,t="",o="0",n="0";precargaExp("#tableConcepto",!0),e=$("#gvGenFacturacion .dato.selected"),o=e[0].getAttribute("data-idfacturacion"),n=document.getElementById("lblTotalConceptoFact").innerText,t=ExtraerDetalleConcepto(),a.append("btnGuardarConcepto","btnGuardarConcepto"),a.append("hdIdFacturacion",o),a.append("txtTotalImporte",n),a.append("detalleConcepto",t),$.ajax({url:"services/facturacion/facturacion-post.php",type:"POST",dataType:"json",data:a,cache:!1,contentType:!1,processData:!1,success:function(a){var t=0;precargaExp("#tableConcepto",!1),t=Number(document.getElementById("lblTotalConceptoFact").innerText),e.find(".subtotal").text(t.toFixed(2)),MessageBox(a.titulomsje,a.contenidomsje,"[Aceptar]",function(){ListarDetalle(o)})},error:function(e){console.log(e)}})}function ObtenerFacturacion(e){$.ajax({url:"services/facturacion/facturacion-search.php",type:"GET",dataType:"json",data:{tipobusqueda:"2",id:e},success:function(e){var a,t=0,o=0;t>0&&(a=$("#gvGenFacturacion .dato.selected"),o=Number(e[0].tm_importefacturado),a.find(".subtotal").text(o.toFixed(2)))},error:function(e){console.log(e)}})}function GenerarPDF(e){var a="",t="",o="",n="";indexList=0,progress=0,nroFacturas=0,elemsSelected=[],completado=!1,progressError=!1,$("#btnFinalizarEnvio").addClass("oculto"),$("#btnCancelarEnvio").removeClass("oculto"),precargaExp("#modalGenPDF",!0),"EMAIL"==e?(a="Envio de emails",t="Facturas enviadas",o="Enviando factura ",n="Envio "):(a="Exportar facturas a PDF",t="Facturas exportadas",o="Exportando factura ",n="Exportación "),$("#lblTitleGenPDF").text(a),$("#lblInfoGenEmail").text(t),$("#lblDesProgIndividual").text(o),$("#lblDesPorcjEnvio").text(n),openModalCallBack("#modalGenPDF",function(){var a=new FormData;a.append("hdIdProyecto",$("#hdIdProyecto").val()),a.append("hdAnho",$("#hdAnho").val()),a.append("hdMes",$("#hdMes").val()),$.ajax({url:"services/files/files__facturacion.php",type:"POST",dataType:"json",data:a,cache:!1,contentType:!1,processData:!1,success:function(a){$.ajax({url:"services/facturacion/facturacion-search.php",type:"GET",dataType:"json",data:{tipo:"ALLFIELDS",tipobusqueda:"1",id:$("#hdIdProyecto").val(),criterio:"",anho:$("#hdAnho").val(),mes:$("#hdMes").val(),pagina:"0"},success:function(a){var t=0;precargaExp("#modalGenPDF",!1),elemsSelected=a,t=a.length,nroFacturas=t,$("#lblNroFactGeneradas").text(t),GenerarArchivo(e,a[0])},error:function(e){console.log(e)}})},error:function(e){console.log(e)}})})}function GenerarIndividual(){$("#pnlImpresionFactura").fadeIn(400,function(){var e="0";precargaExp("#pnlImpresionFactura",!0),e=$("#gvGenFacturacion .dato.selected").attr("data-idfacturacion"),$.ajax({url:"services/facturacion/facturacion-search.php",type:"GET",dataType:"json",data:{tipo:"ALLFIELDS",tipobusqueda:"2",id:e,criterio:""},success:function(e){var a,t=new FormData,o=$("#hdIdProyecto").val();e.length>0?(a=e[0],t.append("btnGenerarPDF","btnGenerarPDF"),t.append("tipoGen","EXPORTACION"),t.append("ddlAnho",$("#hdAnho").val()),t.append("ddlMes",$("#hdMes").val()),t.append("hdIdFacturacion",a.tm_idfacturacion),t.append("hdIdProyecto",a.tm_idproyecto),t.append("hdIdPropiedad",a.idpropiedad),t.append("hdIdPropietario",a.idpropietario),t.append("txtCodigo",a.tm_codigo),t.append("txtFechaEmision",a.tm_fechaemision),t.append("txtFechaVencimiento",a.tm_fechavencimiento),t.append("txtFechaTope",a.tm_fechatope),t.append("txtRatio",a.tm_ratio),t.append("txtSimboloMoneda",a.simbolomoneda),t.append("txtTotalImporte",a.tm_importefacturado),$.ajax({url:"services/facturacion/facturacion-post.php",type:"POST",dataType:"json",data:t,cache:!1,contentType:!1,processData:!1,success:function(e){precargaExp("#pnlImpresionFactura",!1),$("#ifrImpresionFactura").attr("src","media/pdf/"+o+a.tm_per_ano+a.tm_per_mes+"/"+a.tm_idfacturacion+".pdf?new="+(new Date).getTime())},error:function(e){console.log(e)}})):(precargaExp("#pnlImpresionFactura",!1),MessageBox("No se encontraron datos de facturacion","Error en visualizacion","[Aceptar]",function(){$("#pnlImpresionFactura").fadeOut(400,function(){})}))},error:function(e){console.log(e)}})})}function GenerarArchivo(e,a){var t=new FormData;t.append("btnGenerarPDF","btnGenerarPDF"),t.append("tipoGen",e),t.append("ddlAnho",$("#hdAnho").val()),t.append("ddlMes",$("#hdMes").val()),t.append("hdIdFacturacion",a.tm_idfacturacion),t.append("hdIdProyecto",a.tm_idproyecto),t.append("hdIdPropiedad",a.idpropiedad),t.append("hdIdPropietario",a.idpropietario),t.append("txtCodigo",a.tm_codigo),t.append("txtFechaEmision",a.tm_fechaemision),t.append("txtFechaVencimiento",a.tm_fechavencimiento),t.append("txtFechaTope",a.tm_fechatope),t.append("txtRatio",a.tm_ratio),t.append("txtSimboloMoneda",a.simbolomoneda),t.append("txtTotalImporte",a.tm_importefacturado),$.ajax({url:"services/facturacion/facturacion-post.php",type:"POST",dataType:"json",data:t,cache:!1,contentType:!1,processData:!1,success:function(t){var o=0;++indexList,progressError=!1,o=Math.round(100*indexList/nroFacturas),$("#lblNroFactEnviadas").text(indexList),$("#lblPorcentajeEnvio").text(o),$("#lblDescripFactura").text(a.tm_idfacturacion+" - "+a.descripcionpropiedad),indexList<=elemsSelected.length-1?GenerarArchivo(e,elemsSelected[indexList]):(completado=!0,$("#btnFinalizarEnvio").removeClass("oculto"),$("#btnCancelarEnvio").addClass("oculto"),"EMAIL"==e?MessageBox("Env&iacute;o completado","Todas las facturas se enviaron por correo","[Aceptar]",function(){}):ExportarFacturas())},beforeSend:function(){},complete:function(){progress=0,progressError&&0==completado&&setTimeout(function(){GenerarArchivo(e,elemsSelected[indexList])},1e4)},error:function(e){progress=0,progressError=!0,console.log(e)}})}function ExportarPropiedades(){var e=new FormData,a=$("#hdIdProyecto").val(),t=$("#groupVistaConsumo .span-button.btn-success").attr("data-target"),o="consulta"==t?"2":"1";precargaExp("#pnlListado",!0),e.append("btnExportarPropiedad","btnExportarPropiedad"),e.append("hdIdProyecto",a),e.append("hdTipoConsultaExport",o),e.append("ddlAnho",$("#hdAnho").val()),e.append("ddlMes",$("#hdMes").val()),$.ajax({url:"services/facturacion/facturacion-post.php",type:"POST",dataType:"json",data:e,cache:!1,contentType:!1,processData:!1,success:function(e){precargaExp("#pnlListado",!1),MessageBox("Exportaci&oacute;n completada","Todas las propiedades se generaron correctamente","[Aceptar]",function(){window.location="media/xls/"+a+".xlsx"})},error:function(e){console.log(e)}})}function ExportarPropiedades_Concepto(){var e=new FormData,a=$("#hdIdProyecto").val(),t=$("#hdIdConcepto").val(),o=$("#hdAnho").val(),n=$("#hdMes").val(),r=$("#groupVistaConsumo .span-button.btn-success").attr("data-target"),c="consulta"==r?"2":"1";precargaExp("#pnlListado",!0),e.append("btnExportarPropiedad_Concepto","btnExportarPropiedad_Concepto"),e.append("hdIdProyecto",a),e.append("hdTipoConsultaExport",c),e.append("hdIdConcepto",t),e.append("hdAnho",o),e.append("hdMes",n),$.ajax({url:"services/facturacion/facturacion-post.php",type:"POST",dataType:"json",data:e,cache:!1,contentType:!1,processData:!1,success:function(e){precargaExp("#pnlListado",!1),MessageBox("Exportaci&oacute;n completada","Todas las propiedades se generaron correctamente","[Aceptar]",function(){window.location="media/xls/"+a+".xlsx"})},error:function(e){console.log(e)}})}function ExportarDetalleFacturas(){var e=new FormData,a=$("#hdIdProyecto").val(),t=$("#hdAnho").val(),o=$("#hdMes").val();precargaExp("#pnlListado",!0),e.append("btnExportarFacturasExcel","btnExportarFacturasExcel"),e.append("hdIdProyecto",a),e.append("ddlAnho",t),e.append("ddlMes",o),$.ajax({url:"services/facturacion/facturacion-post.php",type:"POST",dataType:"json",data:e,cache:!1,contentType:!1,processData:!1,success:function(e){precargaExp("#pnlListado",!1),MessageBox("Exportaci&oacute;n completada","Todas los detalles de las facturas se generaron correctamente","[Aceptar]",function(){window.location="media/xls/"+a+"_"+t+"_"+o+".xlsx"})},error:function(e){console.log(e)}})}function ExportarTotalesFacturaExcel(){var e=new FormData,a=$("#hdIdProyecto").val(),t=$("#hdAnho").val(),o=$("#hdMes").val();precargaExp("#pnlListado",!0),e.append("btnExportarTotalesFacturaExcel","btnExportarTotalesFacturaExcel"),e.append("hdIdProyecto",a),e.append("ddlAnho",t),e.append("ddlMes",o),$.ajax({url:"services/facturacion/facturacion-post.php",type:"POST",dataType:"json",data:e,cache:!1,contentType:!1,processData:!1,success:function(e){precargaExp("#pnlListado",!1),MessageBox("Exportaci&oacute;n completada","Todas las facturas de este proyecto se exportaron correctamente","[Aceptar]",function(){window.location="media/xls/"+a+"_"+t+"_"+o+"_TF.xlsx?new="+(new Date).getTime()})},error:function(e){console.log(e)}})}function ExportarFacturas(){var e=new FormData;precargaExp("#modalGenPDF",!0),e.append("btnExportar","btnExportar"),e.append("hdIdProyecto",$("#hdIdProyecto").val()),e.append("ddlAnho",$("#hdAnho").val()),e.append("ddlMes",$("#hdMes").val()),$.ajax({url:"services/facturacion/facturacion-post.php",type:"POST",dataType:"json",data:e,cache:!1,contentType:!1,processData:!1,success:function(e){precargaExp("#modalGenPDF",!1),MessageBox("Exportaci&oacute;n completada","Todas las facturas se generaron correctamente","[Aceptar]",function(){VerImpresion(e.contenidomsje+"?new="+(new Date).getTime())})},error:function(e){console.log(e)}})}function VerImpresion(e){$("#pnlImpresionFactura").fadeIn(400,function(){$("#ifrImpresionFactura").attr("src",e)})}function ListarTorreSuministro(){precargaExp("#tableTorre",!0),$.ajax({url:"services/facturacion/facturacion-search.php",type:"GET",dataType:"json",data:{tipo:"TORRES",tipobusqueda:"1",idproyecto:$("#hdIdProyecto").val(),anho:$("#hdAnho").val(),mes:$("#hdMes").val()},success:function(e){var a=0,t=0,o="";if(precargaExp("#tableTorre",!1),
t=e.length,t>0)for(;a<t;)o+='<tr data-iddetalle="'+e[a].td_idconsumoascensor+'" data-idtorre="'+e[a].tm_idtorre+'">',o+="<td>"+e[a].tm_descripciontorre+"</td>",o+='<td><input type="text" name="txtNroSuministro[]" class="inputTextInTable" value="'+e[a].td_nrosuministro+'" /></td>',o+='<td><input type="text" name="txtImporteTorre[]" class="inputTextInTable text-right" value="'+Number(e[a].td_importe).toFixed(2)+'" /></td>',o+="</tr>",++a;$("#tableTorre tbody").html(o),$("#tableTorre .ibody table").enableCellNavigation()},error:function(e){console.log(e)}})}function DetalleTorre(e,a,t,o){this.iditem=e,this.idtorre=a,this.nrosuministro=t,this.importe=o}function ExtraerTorre(){var e,a,t=0,o=0,n=[],r="",c="0",i="0",s="0",d="0";if(e=$("#tableTorre .ibody table"),a=e[0],o=a.rows.length,o>0){for(;t<o;){c=a.rows[t].getAttribute("data-iddetalle"),i=a.rows[t].getAttribute("data-idtorre"),s=a.rows[t].cells[1].childNodes[0].value,d=a.rows[t].cells[2].childNodes[0].value;var l=new DetalleTorre(c,i,s,d);n.push(l),++t}r=JSON.stringify(n)}return r}function RegistrarTorreConsumo(){var e=new FormData;precargaExp("#pnlDetalle > .gp-body",!0),detalleTorre=ExtraerTorre(),e.append("btnRegistrarAscensor","btnRegistrarAscensor"),e.append("hdIdProyecto",$("#hdIdProyecto").val()),e.append("ddlAnho",$("#hdAnho").val()),e.append("ddlMes",$("#hdMes").val()),e.append("detalleTorre",detalleTorre),$.ajax({url:"services/facturacion/facturacion-post.php",type:"POST",dataType:"json",data:e,cache:!1,contentType:!1,processData:!1,success:function(e){precargaExp("#pnlDetalle > .gp-body",!1),MessageBox(e.titulomsje,e.contenidomsje,"[Aceptar]",function(){ListarTorreSuministro()})},error:function(e){console.log(e)}})}function ListarIncidencias(e,a,t,o){var n="#tablePropietario";precargaExp(n,!0),$.ajax({type:"GET",url:"services/facturacion/facturacion-search.php",cache:!1,dataType:"json",data:{tipo:"INCIDENCIAS",idpropiedad:e,idproyecto:a,anho:t,mes:o},success:function(e){var a=0,t=0,o="";if(t=e.length,t>0)for(;a<t;)o+='<tr data-iddetalle="'+e[a].idincidencia+'" data-idpropietario="'+e[a].idpropietario+'" data-seleccionable="false">',o+="<td><h3>"+e[a].descripcion+"</h3></td>",o+='<td><input type="text" name="txtNroDias[]" class="inputTextInTable text-right" value="'+e[a].diasincidencia+'" /></td>',o+="</tr>",++a;$(n+" tbody").html(o),$(n+" .ibody table").enableCellNavigation(),ConfigurarFilasIncidencia(),precargaExp(n,!1)},error:function(e){console.log(e)}})}function ConfigurarFilasIncidencia(){var e=0,a=0,t=0,o=0,n="",r="#tablePropietario";if(e=$('#tablePropietario tbody tr[data-idpropietario!="0"]').length,a=parseInt($("#txtNroPropietarios").val()),$(r+' tbody tr[data-idpropietario="0"]').remove(),e>0&&a>e){for(t=a-e;o<t;)n+='<tr data-iddetalle="0" data-idpropietario="0" data-edit="false" data-seleccionable="true">',n+="<td><h3>SELECCIONAR PROPIETARIO</h3></td>",n+='<td><input type="text" name="txtNroDias[]" class="inputTextInTable text-right" value="0" /></td>',n+="</tr>",++o;$(r+" tbody").append(n),$(r+" .ibody table").enableCellNavigation()}}function DetallePropietario(e,a,t){this.iditem=e,this.idpropietario=a,this.diasincidencia=t}function ExtraerPropietario(){var e,a,t=0,o=0,n=[],r="",c="0",i="0",s="0";if(e=$("#tablePropietario .ibody table"),a=e[0],o=a.rows.length,o>0){for(;t<o;){c=a.rows[t].getAttribute("data-iddetalle"),i=a.rows[t].getAttribute("data-idpropietario"),s=a.rows[t].cells[1].childNodes[0].value;var d=new DetallePropietario(c,i,s);n.push(d),++t}r=JSON.stringify(n)}return r}function DividirFactura(){var e=new FormData,a="0",t="0",o="0",n="0",r="0";precargaExp("#tablePropietario",!0),factura=document.getElementById("lblNroPropiedad"),a=factura.getAttribute("data-idfacturacion"),t=factura.getAttribute("data-idpropiedad"),o=$("#hdIdProyecto").val(),n=$("#hdAnho").val(),r=$("#hdMes").val(),detallePropietario=ExtraerPropietario(),e.append("btnDividirFactura","btnDividirFactura"),e.append("hdIdFacturacion",a),e.append("hdIdPropiedad",t),e.append("hdIdProyecto",o),e.append("ddlAnho",n),e.append("ddlMes",r),e.append("detallePropietario",detallePropietario),$.ajax({url:"services/facturacion/facturacion-post.php",type:"POST",dataType:"json",data:e,cache:!1,contentType:!1,processData:!1,success:function(e){precargaExp("#tablePropietario",!1),MessageBox(e.titulomsje,e.contenidomsje,"[Aceptar]",function(){ListarIncidencias(t,o,n,r)})},error:function(e){console.log(e)}})}function EliminarFacturacion(){indexList=0,elemsSelected=$("#gvGenFacturacion .selected").toArray(),EliminarItemFacturacion(elemsSelected[0])}function EliminarItemFacturacion(e){var a=new FormData,t="0";t=e.getAttribute("data-idfacturacion"),a.append("btnEliminar","btnEliminar"),a.append("hdIdFacturacion",t),$.ajax({url:"services/facturacion/facturacion-post.php",type:"POST",dataType:"json",data:a,cache:!1,contentType:!1,processData:!1,success:function(a){var o,n,r=0,c="",i=0;n=$(e),i=n.height(),"0"==a.rpta?(c="La factura "+t+": "+e.getAttribute("data-codigo"),"ERROR-COBRANZA"==a.contenidomsje&&(c+=" se ha usado en el m&oacute;dulo de cobranza."),MessageBox(a.titulomsje,c,"[Aceptar]",function(){})):(++indexList,o=$("#gvGenFacturacion .gridview"),r=o.scrollTop(),n.fadeOut(400,function(){$(this).remove(),$("#gvGenFacturacion .card").length>0&&$("#gvGenFacturacion .card:first").trigger("click")}),indexList<=elemsSelected.length-1?(r+=i+18,o.animate({scrollTop:r},400,function(){EliminarItemFacturacion(elemsSelected[indexList])})):MessageBox(a.titulomsje,a.contenidomsje,"[Aceptar]",function(){$("#btnRegenerar, #btnEliminar, #btnVistaPrevia, #btnGuardarConcepto, #btnDivisionFactura, #btnEnviarEmail, #btnImprimirFactura").removeClass("oculto")}))},error:function(e){console.log(e)}})}function prepareImport(e){var a=["xls","xlsx"],t="",o="";return fileValue=e[0],o=e[0].name,t=o.split(".").pop().toLowerCase(),$.inArray(t,a)==-1?(MessageBox("Extensi&oacute;n no v&aacute;lida","El tipo de archivo no es compatible para la importaci&oacute;n","[Aceptar]",function(){}),!1):($(".droping-air .help").text(o),$(".droping-air").addClass("dropped"),habilitarControl("#btnSubirDatos",!0),void $("#btnSubirDatos").addClass("success"))}function cancelImport(){$(".droping-air .help").text("Seleccione o arrastre un archivo de Excel"),$(".droping-air").removeClass("dropped"),habilitarControl("#btnSubirDatos",!1),$("#btnSubirDatos").removeClass("success"),$(".droping-air .file-import").val(""),fileValue=!1}function executeImport(){var e=document.getElementById("pbUploadExcel"),a=e.getElementsByClassName("custom_progress_text")[0],t=$("#hdTipoImportacion").val(),o=new FormData;o.append("btnSubirDatos","btnSubirDatos"),o.append("hdTipoImportacion",t),o.append("hdIdProyecto",$("#hdIdProyecto").val()),o.append("hdIdConcepto",$("#hdIdConcepto").val()),o.append("hdConceptoEscalonable",$("#hdConceptoEscalonable").val()),o.append("ddlAnhoImport",$("#hdAnho").val()),o.append("ddlMesImport",$("#hdMes").val()),o.append("archivo",fileValue);var n=new XMLHttpRequest;n.onreadystatechange=function(){if(4==n.readyState){try{var e=JSON.parse(n.response);MessageBox(e.titulomsje,e.contenidomsje,"[Aceptar]",function(){"0"!=e.rpta&&(closeCustomModal("#modalUploadExcel"),cancelImport(),"00"==t?(ListarPropiedadConsumo("consulta"),ListarSumaConceptoAgua()):"01"==t?ListarPropiedadConsumo_Concepto("consulta"):ListarFacturacion("#gvGenFacturacion","1"))})}catch(a){var e={status:"error",data:"Unknown error occurred: ["+n.responseText+"]"}}console.log(e.status+": "+e.data)}},n.upload.addEventListener("progress",function(t){var o=100*Math.ceil(t.loaded/t.total)+"%";e.style.width=o,a.textContent=o},!1),n.open("POST","services/facturacion/facturacion-post.php"),n.send(o)}function executeImport2(){var e=fileValue,a=new FormData,t=$("#hdTipoImportacion").val();a.append("btnSubirDatos","btnSubirDatos"),a.append("hdTipoImportacion",t),a.append("hdIdProyecto",$("#hdIdProyecto").val()),a.append("hdIdConcepto",$("#hdIdConcepto").val()),a.append("hdConceptoEscalonable",$("#hdConceptoEscalonable").val()),a.append("ddlAnhoImport",$("#hdAnho").val()),a.append("ddlMesImport",$("#hdMes").val()),a.append("archivo",e),$.ajax({type:"POST",url:"services/facturacion/facturacion-post.php",contentType:!1,processData:!1,cache:!1,dataType:"json",data:a,success:function(e){progressError=!1,"0"!=e.rpta&&(progressSuccess=!0),MessageBox(e.titulomsje,e.contenidomsje,"[Aceptar]",function(){"0"!=e.rpta&&(closeCustomModal("#modalUploadExcel"),cancelImport(),"00"==t?(ListarPropiedadConsumo("consulta"),ListarSumaConceptoAgua()):"01"==t?ListarPropiedadConsumo_Concepto("consulta"):ListarFacturacion("#gvGenFacturacion","1"))})},complete:function(){progress=0,progressError&&setTimeout(function(){executeImport()},1e4)},error:function(e){progress=0,progressError=!0,console.log(e)}})}function ListarSumaConceptoAgua(){var e=new FormData;e.append("btnSumarAgua","btnSumarAgua"),e.append("hdIdProyecto",$("#hdIdProyecto").val()),e.append("hdAnho",$("#hdAnho").val()),e.append("hdMes",$("#hdMes").val()),$.ajax({url:"services/facturacion/facturacion-post.php",type:"POST",dataType:"json",cache:!1,contentType:!1,processData:!1,data:e,success:function(e){var a=Number(e.titulomsje);$("#lblTotalConsumo_Soles").text(a.toFixed(2))},error:function(e){progress=0,progressError=!0,console.log(e)}})}function IngresarFechasConsumo(){var e=0,a=$("#tablePropiedad .ibody table"),t=a[0],o=t.rows.length,n=$("#txtFechaIniConsumo").val(),r=$("#txtFechaFinConsumo").val();if(o>0)for(;e<o;)t.rows[e].cells[5].childNodes[0].value=n,t.rows[e].cells[6].childNodes[0].value=r,++e}function GenerarConceptoVariable(){habilitarControl("#btnGenerarConceptoVariable",!1);var e=new FormData,a=$("#modalConceptoVariableGen :input").serializeArray();e.append("btnGenerarConceptoVariable","btnGenerarConceptoVariable"),e.append("hdIdProyecto",$("#hdIdProyecto").val()),e.append("hdAnho",$("#hdAnho").val()),e.append("hdMes",$("#hdMes").val()),$.each(a,function(a,t){e.append(t.name,t.value)}),$.ajax({type:"POST",url:"services/facturacion/facturacion-post.php",contentType:!1,processData:!1,cache:!1,dataType:"json",data:e,success:function(e){MessageBox(e.titulomsje,e.contenidomsje,"[Aceptar]",function(){"0"!=e.rpta&&($("#txtImporteSaldo").val("0.00"),closeCustomModal("#modalConceptoVariableGen"))})},error:function(e){console.log(e)}})}$(function(){$("#txtFechaIniConsumo").mask("99/99/9999"),cargarDatePicker("#txtFechaIniConsumo",function(e,a){}),$("#txtFechaFinConsumo").mask("99/99/9999"),cargarDatePicker("#txtFechaFinConsumo",function(e,a){}),$("#txtImporteSaldo").on("focus",function(e){e.preventDefault(),$(this).select()}),$("#btnIngresoFechasConsumo").on("click",function(e){e.preventDefault(),$("#txtFechaFinConsumo").val(""),$("#txtFechaIniConsumo").val(""),bootbox.confirm("¿Desea utilizar el rango de fechas que provee el sistema, el cual toma como referencia inicial el año y el mes del proceso actual?",function(e){if(e){var a=new Date($("#hdAnho").val(),Number($("#hdMes").val())-1,1);$("#txtFechaIniConsumo").val(moment(a).format("DD/MM/YYYY"));var t=new Date(a.setMonth(a.getMonth()+1));$("#txtFechaFinConsumo").val(moment(t).format("DD/MM/YYYY")),IngresarFechasConsumo()}else openModalCallBack("#modalIngresoFechasConsumo",function(){$("#txtFechaIniConsumo").focus()})})}),$("#btnIngresarFechasConsumo").on("click",function(e){e.preventDefault(),IngresarFechasConsumo(),closeCustomModal("#modalIngresoFechasConsumo")}),$("#txtSearchConcepto").easyAutocomplete({url:function(e){return"services/concepto/concepto-search.php?criterio="+e+"&tipobusqueda=4&tipoconcepto=02&idproyecto="+$("#hdIdProyecto").val()},getValue:function(e){return e.tm_idconcepto+" - "+e.tm_descripcionconcepto},list:{onChooseEvent:function(){var e=$("#txtSearchConcepto").getSelectedItemData().tm_idconcepto;$("#hdIdConcepto").val(e).trigger("change"),$("#btnConsultarConsumo").trigger("click")}},template:{type:"custom",method:function(e,a){return a.tm_idconcepto+" - "+a.tm_descripcionconcepto}},theme:"square"}),$("#btnCancelarCalculoAgua").on("click",function(e){e.preventDefault(),$("#pnlCalculoAguaMeses").fadeOut(400,function(){})}),$("#btnExportarPropiedad").on("click",function(e){e.preventDefault(),ExportarPropiedades()}),$("#btnExportarPropiedad_Concepto").on("click",function(e){e.preventDefault(),ExportarPropiedades_Concepto()}),$("#btnExportarFacturasExcel").on("click",function(e){e.preventDefault(),ExportarDetalleFacturas()}),$("#btnExportarTotalesFacturaExcel").on("click",function(e){e.preventDefault(),ExportarTotalesFacturaExcel()}),$("#btnImportarPropiedad").on("click",function(e){e.preventDefault(),$("#hdTipoImportacion").val("00"),$("#pnlImportConsumo").removeClass("gp-no-header").find(".gp-header").removeClass("oculto"),$("#pnlInfoConcepto").removeClass("hide"),openCustomModal("#modalUploadExcel")}),$("#btnImportarPropiedad_Concepto").on("click",function(e){e.preventDefault(),$("#hdTipoImportacion").val("01"),$("#pnlImportConsumo").removeClass("gp-no-header").find(".gp-header").removeClass("oculto"),$("#pnlInfoConcepto").addClass("hide"),openCustomModal("#modalUploadExcel")}),$("#btnImportarDetalleFacturas").on("click",function(e){e.preventDefault(),$("#hdTipoImportacion").val("01"),$("#pnlImportConsumo").addClass("gp-no-header").find(".gp-header").addClass("oculto"),openCustomModal("#modalUploadExcel")}),$(".droping-air .file-import").on({dragenter:function(e){e.stopPropagation(),e.preventDefault()},dragover:function(e){e.stopPropagation(),e.preventDefault()},change:function(e){e.preventDefault(),prepareImport(this.files)},drop:function(e){e.preventDefault();var a=e.originalEvent.dataTransfer.files;prepareImport(a)}}),$("#btnCancelarSubida").on("click",function(e){e.preventDefault(),cancelImport()}),$("#btnSubirDatos").on("click",function(e){e.preventDefault(),executeImport()}),$("#ddlTipoPropiedadFacturacion").on("change",function(e){e.preventDefault(),paginaGenFacturacion=1,ListarFacturacion("#gvGenFacturacion","1")}),$("#txtSearchFacturacion").keydown(function(e){if(e.keyCode==$.ui.keyCode.ENTER)return $("#btnSearchFacturacion").trigger("click"),!1}).keypress(function(e){if(e.keyCode==$.ui.keyCode.ENTER)return!1}),$("#btnGeneracionConceptoVariable").on("click",function(e){e.preventDefault(),$("#lblTotalConsumo_Gen").text($("#lblTotalConsumo_Soles").text()),$("#hdTotalConsumo_Gen").val($("#lblTotalConsumo_Soles").text()),habilitarControl("#btnGenerarConceptoVariable",!0),openCustomModal("#modalConceptoVariableGen")}),$("#btnGenerarConceptoVariable").on("click",function(e){e.preventDefault(),GenerarConceptoVariable()}),$("#btnSearchFacturacion").on("click",function(e){e.preventDefault(),paginaGenFacturacion=1,ListarFacturacion("#gvGenFacturacion","1")}),$("#groupOpcionesFactura").on("click","button",function(e){var a=this.getAttribute("data-target");$(this).siblings(".btn-success").removeClass("btn-success"),$(this).addClass("btn-success"),$("#pnlListado > .gp-body section.tab-principal").hide(),$(a).show(),"#tabFacturacion"==a?(addValidFormRegister(),$("#groupVistaConsumo, #groupConcepto").addClass("hide"),$("#groupFechas").removeClass("hide"),paginaGenFacturacion=1,ListarFacturacion("#gvGenFacturacion","1")):(removeValidFormRegister(),"#tabCalculoEscalonable"==a?($("#btnConsultarConsumo").trigger("click"),$("#groupFechas, #groupConcepto").addClass("hide"),$("#groupVistaConsumo").removeClass("hide"),$("#btnNuevoConsumo").removeClass("hide")):"#tabConceptoVariable"==a?($("#btnConsultarConsumo").trigger("click"),$("#groupFechas").addClass("hide"),$("#groupVistaConsumo, #groupConcepto").removeClass("hide"),$("#btnNuevoConsumo").removeClass("hide")):"#tabCalculoAscensor"==a&&($("#btnConsultarConsumo").trigger("click"),$("#groupFechas, #groupConcepto").addClass("hide"),$("#groupVistaConsumo").removeClass("hide"),$("#btnNuevoConsumo").addClass("hide")))}),$("#txtSearchFiltro").keydown(function(e){if(e.keyCode==$.ui.keyCode.ENTER)return $("#btnSearchFiltro").trigger("click"),!1}).keypress(function(e){if(e.keyCode==$.ui.keyCode.ENTER)return!1}),$("#btnSearchFiltro").on("click",function(e){e.preventDefault(),ListarProyectos("1")}),$("#groupVistaConsumo").on("click",".span-button",function(e){e.preventDefault();var a=$("#groupOpcionesFactura .btn-success"),t=this.getAttribute("data-target"),o=a.attr("data-target");$("#groupVistaConsumo .btn.btn-success").removeClass("btn-success"),$(this).addClass("btn-success"),"#tabCalculoEscalonable"==o?($("#pnlTotalConsumoSoles").removeClass("hide"),ListarPropiedadConsumo(t),ListarSumaConceptoAgua()):"#tabConceptoVariable"==o?($("#pnlTotalConsumoSoles").addClass("hide"),$("#hdIdConcepto").val()>"0"&&ListarPropiedadConsumo_Concepto(t)):"#tabCalculoAscensor"==o&&($("#pnlTotalConsumoSoles").addClass("hide"),ListarTorreSuministro())}),$("#txtFechaVencimiento").mask("99/99/9999"),cargarDatePicker("#txtFechaVencimiento",function(e,a){}),$("#txtFechaTope").mask("99/99/9999"),cargarDatePicker("#txtFechaTope",function(e,a){}),$("#btnLimpiarSeleccion").on("click",function(e){e.preventDefault(),$("#hdIdPrimary").val("0"),$("#gvDatos .dato.selected").removeClass("selected"),$("#gvDatos input:checkbox:checked").removeAttr("checked"),$("#btnSelectAll").removeClass("oculto"),$("#btnLimpiarSeleccion, #btnGenerar").addClass("oculto")}),$("#btnSelectAll").on("click",function(e){e.preventDefault(),$(this).addClass("oculto"),$("#gvDatos .dato").addClass("selected"),$("#gvDatos input:checkbox").attr("checked",""),$("#btnLimpiarSeleccion, #btnGenerar").removeClass("oculto")}),$("#gvDatos > .items-area").on("scroll",function(){var e=0;$(this).scrollTop()+$(this).innerHeight()>=$(this)[0].scrollHeight&&(e=Number($("#hdPagePresupuesto").val()),ListarPresupuesto(e))}),$("#btnBackPrevPanel").on("click",function(e){e.preventDefault(),BackToPrevPanel()}),$("#btnAddDetalle").on("click",function(e){e.preventDefault()}),$("#pnlInfoProyecto").add("#pnlConsumoProyecto").add("#pnlInfoConcepto").on("click",function(e){e.preventDefault();var a,t="",o="";a=this,t=a.getAttribute("data-tipofiltro"),o=a.getAttribute("data-hint"),paginaFiltro=1,"proyecto"!=t&&"consumo"!=t&&"concepto"!=t||($("#pnlDatosFiltro").removeClass("with-appbar"),$("#pnlDatosFiltro .appbar").addClass("oculto"),"concepto"==t?ListarConcepto("1"):ListarProyectos("1")),$("#pnlDatosFiltro").attr("data-tipofiltro",t),$("#txtTituloFiltro").text(o),$("#pnlDatosFiltro").fadeIn(400,function(){})}),$("#btnHideFiltro").on("click",function(e){e.preventDefault(),$("#pnlDatosFiltro").fadeOut(400,function(){})}),$("#gvFiltro > .items-area").on("scroll",function(){var e=0,a="";$(this).scrollTop()+$(this).innerHeight()>=$(this)[0].scrollHeight&&(e=Number($("#hdPage").val()),a=$("#pnlDatosFiltro").attr("data-tipofiltro"),"proyecto"==a?ListarProyectos(e):"concepto"==a&&ListarConcepto(e))}),$("#btnClearFilter").on("click",function(e){e.preventDefault(),$("#btnClearFilter, #btnAsignFilter").addClass("oculto"),$("#btnSelectAllFilter").removeClass("oculto"),$("#gvFiltro input:checkbox").removeAttr("checked"),$("#gvFiltro .dato").removeClass("selected")}),$("#btnSelectAllFilter").on("click",function(e){e.preventDefault(),$(this).addClass("oculto"),$("#btnClearFilter, #btnAsignFilter").removeClass("oculto"),$("#gvFiltro input:checkbox").attr("checked",""),$("#gvFiltro .dato").addClass("selected")}),$("#btnAsignFilter").on("click",function(e){e.preventDefault(),AgregarPresupuesto()}),$("#gvFiltro").on("click",".dato",function(e){e.preventDefault();var a,t="0",o="",n="0",r="";a=document.getElementById("pnlDatosFiltro"),r=a.getAttribute("data-tipofiltro"),"proyecto"==r?(t=this.getAttribute("data-idproyecto"),o=this.getAttribute("data-nombre"),n=this.getAttribute("data-escobrodiferenciado"),$("#ddlMes").val(this.getAttribute("data-mes")),setProyecto(t,o,n)):"consumo"==r?(t=this.getAttribute("data-idproyecto"),o=this.getAttribute("data-nombre"),n=this.getAttribute("data-escobrodiferenciado"),setConsumoProyecto(t,o,n)):"concepto"==r&&(t=this.getAttribute("data-idconcepto"),o=this.getAttribute("data-descripcion"),setConcepto(t,o))}),$("#gvGenFacturacion > .gridview").on("scroll",function(){var e=0;$(this).scrollTop()+$(this).innerHeight()>=$(this)[0].scrollHeight&&(e=Number($("#hdPageGenFacturacion").val()),ListarFacturacion("#gvGenFacturacion",e))}),$("#gvGenFacturacion").on("click",".dato",function(e){e.preventDefault();var a="0";$("#gvGenFacturacion .dato.selected").removeClass("selected"),$(this).addClass("selected"),a=this.getAttribute("data-idfacturacion"),ListarDetalle(a)}),$("#btnEliminar").on("click",function(e){e.preventDefault(),confirma=confirm("¿Desea eliminar los elementos seleccionados?"),confirma&&EliminarFacturacion()}),$("#form1").validate({lang:"es",showErrors:showErrorsInValidate}),$("#btnEnviarEmail").on("click",function(e){e.preventDefault();var a=confirm("¿Desea iniciar el envío de facturas por corre? Esto puede llevar varios minutos...");a&&GenerarPDF("EMAIL")}),$("#btnImprimirFactura").on("click",function(e){e.preventDefault(),MessageBox("¿Que desea hacer?","M&oacute;dulo de impresi&oacute;n","[Salir sin cambios], [Ver impresion], [Generar impresion]",function(e){"Ver impresion"==e?VerImpresion("media/pdf/"+$("#hdIdProyecto").val()+$("#hdAnho").val()+$("#hdMes").val()+".pdf?new="+(new Date).getTime()):"Salir sin cambios"==e?alert("No se realizó ninguna operación"):GenerarPDF("EXPORTACION")})}),$("#tablePropiedad tbody").on({click:function(e){if(e.preventDefault(),$(this).hasClass("lecanterior")||$(this).hasClass("lecactual"))return $(this).select(),!1},keyup:function(e){if($(this).hasClass("lecanterior")||$(this).hasClass("lecactual")){var a=0,t=0;$(this).hasClass("lecanterior")?(a=Number($(this).val()),t=Number($(this).parent().parent().find(".lecactual").val())):$(this).hasClass("lecactual")&&(a=Number($(this).parent().parent().find(".lecanterior").val()),t=Number($(this).val()));var o=t-a;o<0?$(this).parent().parent().addClass("red white-text"):$(this).parent().parent().removeClass("red white-text"),$(this).parent().parent().find(".consumo").text(o.toFixed(3)),$(this).parent().parent().find(".input-consumo").val(o.toFixed(3))}}},"input:text"),$("#btnCalcularConsumo").on("click",function(e){e.preventDefault(),RegistrarCalculoConsumo()}),$("#btnCalcularConsumo_Concepto").on("click",function(e){e.preventDefault(),RegistrarCalculoConsumo_Concepto()}),$("#btnCalConsumoMeses").on("click",function(e){e.preventDefault(),ShowPanelCalculoAguaMeses()}),$("#btnGenerarCalculoAgua").on("click",function(e){e.preventDefault(),CalcularAguaMeses()}),$("#btnBackToFacturacion").on("click",function(e){e.preventDefault(),$("#pnlCalculoAguaMeses").fadeOut(400,function(){})}),$("#btnConfirmarTorre").on("click",function(e){e.preventDefault(),RegistrarTorreConsumo()}),$("#btnGuardarConcepto").on("click",function(e){e.preventDefault(),GuardarConceptoFact()}),$("#btnCloseGenPDF").add("#btnCancelarEnvio").on("click",function(e){e.preventDefault(),0==completado&&(confirma=confirm("¿Está seguro de cancelar el envío?"),confirma&&(progress=0,indexList=0,a())),closeCustomModal("#modalGenPDF")}),$("#btnCloseGenFacturacion").add("#btnCancelarEnvio_Facturacion").on("click",function(e){e.preventDefault(),0==completado&&(confirma=confirm("¿Está seguro de cancelar el envío?"),confirma&&(progress=0,indexList=0,a())),closeCustomModal("#modalGenFacturacion")}),$("#btnFinalizarEnvio").on("click",function(e){e.preventDefault(),closeCustomModal("#modalGenPDF")}),$("#btnFinalizarEnvio_Facturacion").on("click",function(e){e.preventDefault(),closeCustomModal("#modalGenFacturacion")});var e=[];$(document).ajaxSend(function(a,t,o){e.push(t)}),$(document).ajaxComplete(function(a,t,o){e=$.grep(e,function(e){return e!=t})});var a=function(){completado=!0,$.each(e,function(e,a){a.abort()})};$("#btnDivisionFactura").on("click",function(e){e.preventDefault();var a,t="0",o="0",n="",r="0",c="",i="",s="";a=$("#gvGenFacturacion .dato.selected")[0],t=a.getAttribute("data-idfacturacion"),o=a.getAttribute("data-idpropiedad"),n=a.getAttribute("data-nombre"),r=$("#hdIdProyecto").val(),c=$("#hdAnho").val(),i=$("#hdMes").val(),s=arrMeses[Number($("#hdMes").val())-1],$("#lblNroPropiedad").attr({"data-idfacturacion":t,"data-idpropiedad":o}).text(n),$("#lblAnhoMesDiv").text(s+"-"+c),openModalCallBack("#modalDivision",function(){ListarIncidencias(o,r,c,i)})}),$("#txtNroPropietarios").on({keydown:function(e){if(e.keyCode==$.ui.keyCode.ENTER)return $("#tablePropietario tbody tr").length>0&&$("#tablePropietario tbody .inputTextInTable:first-child").focus(),!1},keypress:function(e){if(e.keyCode==$.ui.keyCode.ENTER)return!1},keyup:function(e){ConfigurarFilasIncidencia()}}),$("#tablePropietario tbody").on("click",'tr[data-seleccionable="true"]',function(e){e.preventDefault();var a="index.php?pag=admin&subpag=propietario&screenmode=search";$('#tablePropietario tbody tr[data-seleccionable="true"]').attr("data-edit","false"),$(this).attr("data-edit","true"),$("#pnlSearchPropietario").fadeIn(400,function(){$("#ifrSearchPropietario").hasClass("loaded")||$("#ifrSearchPropietario").attr("src",a).addClass("loaded")})}),$("#tablePropietario tbody").on("click",".inputTextInTable",function(e){return e.preventDefault(),!1}),$("#ifrSearchPropietario").on("load",function(){$(this).contents().find("body, body *").on("click",function(e){window.top.hideAllSlidePanels()})}),$("#btnDividirFactura").on("click",function(e){e.preventDefault(),DividirFactura()}),$("#tableConcepto tbody").on("keyup",".inputTextInTable",function(e){e.preventDefault(),CalcularTotal()}),$("#btnGenerar").on("click",function(e){e.preventDefault();var a=window.top.estadoproceso;1==a?EliminarFacturacionPrevia():bootbox.alert("El proceso con el que se está trabajando está cerrado, no es posible generar con un proceso cerrado")}),$("#btnRegenerar").on("click",function(e){e.preventDefault();var a=window.top.estadoproceso;1==a?RegenerarFacturacion():bootbox.alert("El proceso con el que se está trabajando está cerrado, no es posible generar con un proceso cerrado")}),$("#btnHideImpresion").on("click",function(e){e.preventDefault(),$("#pnlImpresionFactura").fadeOut(400)}),$("#btnVistaPrevia").on("click",function(e){e.preventDefault(),GenerarIndividual()})});var paginaPropiedad=1,paginaFiltro=1,paginaProyecto=1,paginaConcepto=1,paginaFacturacion=1,paginaGenFacturacion=1,arrMeses=["Enero","Febrero","Marzo","Abril","Mayo","Junio","Julio","Agosto","Septiembre","Octubre","Noviembre","Diciembre"],indexList=0,elemsSelected,progress=0,completado=!1,nroFacturas=0,fileValue=!1,progressError=!1,progressSuccess=!1,o={38:"up",40:"bottom",37:"prev",39:"next"};